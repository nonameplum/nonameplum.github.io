<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="≈Åukasz ≈öliwi≈Ñski"/><link rel="canonical" href="https://nonameplum.github.io/posts/Unit%20tests%20with%20several%20localizations"/><meta name="twitter:url" content="https://nonameplum.github.io/posts/Unit%20tests%20with%20several%20localizations"/><meta name="og:url" content="https://nonameplum.github.io/posts/Unit%20tests%20with%20several%20localizations"/><title>How to make unit tests with several localizations | ≈Åukasz ≈öliwi≈Ñski</title><meta name="twitter:title" content="How to make unit tests with several localizations | ≈Åukasz ≈öliwi≈Ñski"/><meta name="og:title" content="How to make unit tests with several localizations | ≈Åukasz ≈öliwi≈Ñski"/><meta name="description" content="Unit tests with several localizations"/><meta name="twitter:description" content="Unit tests with several localizations"/><meta name="og:description" content="Unit tests with several localizations"/><meta http-equiv="cache-control" content="no-cache"/><meta http-equiv="expires" content="no-cache"/><meta http-equiv="pragma" content="no-cache"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><link rel="stylesheet" href="/code.css" type="text/css"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Comfortaa"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to ≈Åukasz ≈öliwi≈Ñski"/></head><body class="item-page"><header><div class="wrapper"><div class="title"><a class="site-logo" href="/">üì±</a><a class="site-name" href="/">≈Åukasz ≈öliwi≈Ñski</a><a class="site-subname" href="/">Software Developer Blog</a></div><div class="avatar-wrapper"><a href="https://github.com/nonameplum"><img src="https://avatars.githubusercontent.com/u/1753816?v=4" class="avatar"/></a></div></div></header><div class="wrapper"><article><div class="content"><h1>How to make unit tests with several localizations</h1><p>Since Xcode 11 there is a possibility to configure different locales for unit tests by using <a href="https://developer.apple.com/videos/play/wwdc2019/413/">Test Plans</a>. It is fine, but a little bit cumbersome as requires the Xcode-specific configuration. Another way of making it work is the old-school method swizzling. It is quite simple to do and does its job with quite nice flexibility. It doesn't require any Xcode setup, works well with SPM too. The idea could be also extended to customize not only the <a href="https://developer.apple.com/documentation/foundation/locale"><code>Locale</code></a>, but also e.g. <a href="https://developer.apple.com/documentation/foundation/locale/2293155-preferredlanguages"><code>preferredlanguages</code></a>. The key point is that we can do it by exchanging the methods on <code>NSLocale</code> instead of <code>Locale</code> which still is used as a wrapper over <a href="https://github.com/apple/swift-corelibs-foundation/blob/bfead15ba7a547a8e2ea79dfd8be97de1153245d/Sources/Foundation/Locale.swift">the objective-c predecessor</a>.</p><p>We can use <code>method_setImplementation</code> and <a href="https://apple-swift.readthedocs.io/en/latest/SIL.html"><code>@convention(block)</code></a> (<a href="https://docs.swift.org/swift-book/ReferenceManual/Attributes.html">swift documentation</a>) in this case, which makes it a little bit more ergonomic than defining the <code>@objc</code> method that would solve the purpose of the exchanged method.</p><pre><code><span class="keyword">extension</span> <span class="type">XCTestCase</span> {
   <span class="keyword">func</span> setLocale(identifier: <span class="type">String</span>, preferredLanguages: [<span class="type">String</span>]) {
        <span class="keyword">let</span> currentlLocale: <span class="keyword">@convention</span>(block) (<span class="type">AnyObject</span>)
            -&gt; <span class="type">AnyObject</span> = { (_: <span class="type">AnyObject</span>!) -&gt; <span class="type">NSLocale</span> <span class="keyword">in
                return</span> <span class="type">NSLocale</span>(localeIdentifier: identifier)
            }

        <span class="call">method_setImplementation</span>(
            <span class="call">class_getClassMethod</span>(<span class="type">NSLocale</span>.<span class="keyword">self</span>, #selector(getter: <span class="type">NSLocale</span>.<span class="property">current</span>))!,
            <span class="call">imp_implementationWithBlock</span>(currentlLocale)
        )

        <span class="keyword">let</span> preferredLanguages: <span class="keyword">@convention</span>(block) (<span class="type">AnyObject</span>)
            -&gt; [<span class="type">String</span>] = { (_: <span class="type">AnyObject</span>!) -&gt; [<span class="type">String</span>] <span class="keyword">in
                return</span> preferredLanguages
            }

        <span class="call">method_setImplementation</span>(
            <span class="call">class_getClassMethod</span>(<span class="type">NSLocale</span>.<span class="keyword">self</span>, #selector(getter: <span class="type">NSLocale</span>.<span class="property">preferredLanguages</span>))!,
            <span class="call">imp_implementationWithBlock</span>(preferredLanguages)
        )
    }
}
</code></pre><p>Having that we can easily change the <code>Locale</code> for each test. The only downside is that you still use singleton <code>Locale.current</code>, so running tests in parallel will not work reliably.</p><pre><code><span class="keyword">class</span> Test: <span class="type">XCTestCase</span> {
    <span class="keyword">func</span> test_locale() {
        <span class="call">setLocale</span>(identifier: <span class="string">"fr"</span>, preferredLanguages: [<span class="string">"fr"</span>, <span class="string">"de"</span>, <span class="string">"pl"</span>])

        <span class="call">XCTAssertEqual</span>(<span class="type">Locale</span>.<span class="property">current</span>, .<span class="keyword">init</span>(identifier: <span class="string">"fr"</span>))
        <span class="call">XCTAssertEqual</span>(<span class="type">Locale</span>.<span class="property">preferredLanguages</span>, [<span class="string">"fr"</span>, <span class="string">"de"</span>, <span class="string">"pl"</span>])
   
</code></pre></div><span>Tagged with: </span><ul class="tag-list"><li style="background-color: #1d76db;"><a href="/tags/swift">swift</a></li><li style="background-color: #006b75;"><a href="/tags/xcode">Xcode</a></li><li style="background-color: #D57125;"><a href="/tags/tests">tests</a></li></ul></article></div><footer><p>Generated using <a href="https://github.com/johnsundell/publish">Publish</a></p><p><a href="/feed.rss">RSS feed</a></p></footer></body></html>